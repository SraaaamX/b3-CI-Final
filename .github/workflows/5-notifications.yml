name: Deployment Notifications

on:
  workflow_call:
    inputs:
      deployment-status:
        required: true
        type: string
      version:
        required: true
        type: string
      commit-sha:
        required: true
        type: string
    secrets:
      BACKEND_URL:
        required: true
      VPS_HOST:
        required: true

jobs:
  notify-success:
    name: Notify Deployment Success
    runs-on: ubuntu-latest
    if: inputs.deployment-status == 'success'
    steps:
      - name: Create deployment summary
        uses: actions/github-script@v7
        with:
          script: |
            const summary = `## ✓ Deployment Successful
            
            **Version:** ${{ inputs.version }}
            **Commit:** ${{ inputs.commit-sha }}
            **Timestamp:** ${new Date().toISOString()}
            
            ### Services Status
            | Service | Status | URL |
            |---------|--------|-----|
            | Backend | ✓ HEALTHY | ${{ secrets.BACKEND_URL }} |
            | Frontend | ✓ HEALTHY | http://${{ secrets.VPS_HOST }}/ |
            
            ### Deployment Steps
            - ✓ Backend deployed to Render
            - ✓ Frontend built successfully
            - ✓ Frontend deployed to VPS
            - ✓ PM2 process reloaded (zero-downtime)
            - ✓ Health checks passed
            
            All services are operational and ready to serve traffic.`;
            
            await core.summary
              .addRaw(summary)
              .write();
            
            console.log('✓ Deployment summary created');

      - name: Log deployment success
        run: |
          echo "========================================="
          echo "✓ DEPLOYMENT SUCCESSFUL"
          echo "========================================="
          echo "Version: ${{ inputs.version }}"
          echo "Commit: ${{ inputs.commit-sha }}"
          echo "Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo ""
          echo "Services:"
          echo "  Backend: ${{ secrets.BACKEND_URL }}"
          echo "  Frontend: http://${{ secrets.VPS_HOST }}/"
          echo ""
          echo "All services operational and health checks passed"
          echo "========================================="

  notify-failure:
    name: Notify Deployment Failure
    runs-on: ubuntu-latest
    if: inputs.deployment-status == 'failure'
    steps:
      - name: Create failure summary
        uses: actions/github-script@v7
        with:
          script: |
            const summary = `## ✗ Deployment Failed
            
            **Version:** ${{ inputs.version }}
            **Commit:** ${{ inputs.commit-sha }}
            **Timestamp:** ${new Date().toISOString()}
            
            ### Actions Required
            1. Check the workflow logs for the failed step
            2. Review error messages and stack traces
            3. Consider rolling back if needed
            
            ### Rollback Options
            - **Backend**: Redeploy previous version via Render dashboard
            - **Frontend**: Revert commit and push, or manual PM2 rollback
            - **Both**: Use git revert and trigger new deployment
            
            Please investigate the failure before attempting another deployment.`;
            
            await core.summary
              .addRaw(summary)
              .write();
            
            core.setFailed('Deployment pipeline failed');
            console.log('✗ Failure summary created');

      - name: Log deployment failure
        run: |
          echo "========================================="
          echo "✗ DEPLOYMENT FAILED"
          echo "========================================="
          echo "Version: ${{ inputs.version }}"
          echo "Commit: ${{ inputs.commit-sha }}"
          echo "Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo ""
          echo "ALERT: Check the logs above for details"
          echo "Action required: Investigate failure and consider rollback"
          echo ""
          echo "Rollback documentation: See README.md"
          echo "========================================="
          exit 1
