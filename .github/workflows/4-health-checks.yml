name: Health Checks

on:
  workflow_call:
    secrets:
      BACKEND_URL:
        required: true
      VPS_HOST:
        required: true

jobs:
  health-checks:
    name: Verify Services Health
    runs-on: ubuntu-latest
    steps:
      - name: Wait for backend readiness
        uses: nev7n/wait_for_response@v1
        with:
          url: ${{ secrets.BACKEND_URL }}/
          responseCode: 200
          timeout: 180000
          interval: 10000

      - name: Health Check Backend Root
        run: |
          echo "Checking backend root endpoint..."
          curl -f ${{ secrets.BACKEND_URL }}/ || exit 1
          echo "Backend root endpoint is accessible"

      - name: Health Check Backend API
        run: |
          echo "Checking backend API endpoint..."
          curl -f ${{ secrets.BACKEND_URL }}/api/game || exit 1
          echo "Backend API endpoint is accessible"

      - name: Wait for frontend readiness
        uses: nev7n/wait_for_response@v1
        with:
          url: http://${{ secrets.VPS_HOST }}/
          responseCode: 200
          timeout: 30000
          interval: 2000

      - name: Health Check Frontend
        run: |
          echo "Checking frontend endpoint..."
          curl -f http://${{ secrets.VPS_HOST }}/ || exit 1
          echo "Frontend endpoint is accessible"

      - name: Log Health Checks Success
        run: |
          echo "SUCCESS: All health checks passed"
          echo "Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "Backend root: PASSED"
          echo "Backend API: PASSED"
          echo "Frontend: PASSED"
          echo "Backend URL: ${{ secrets.BACKEND_URL }}"
          echo "Frontend URL: http://${{ secrets.VPS_HOST }}/"
