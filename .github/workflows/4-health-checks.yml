name: Health Checks

on:
  workflow_call:
    secrets:
      BACKEND_URL:
        required: true
      VPS_HOST:
        required: true

jobs:
  health-checks:
    name: Verify Services Health
    runs-on: ubuntu-latest
    steps:
      - name: Health Check Backend
        id: backend-check
        run: |
          echo "Checking backend endpoint..."
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" ${{ secrets.BACKEND_URL }}/)
          echo "Backend HTTP status: $RESPONSE"
          if [ "$RESPONSE" != "200" ]; then
            echo "Backend health check failed with status $RESPONSE"
            exit 1
          fi

      - name: Log Backend Health
        run: |
          echo "✓ Backend health check passed"
          echo "URL: ${{ secrets.BACKEND_URL }}/"
          echo "Status: Healthy"
          echo "Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"

      - name: Health Check Frontend
        id: frontend-check
        run: |
          echo "Checking frontend endpoint..."
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" http://${{ secrets.VPS_HOST }}/)
          echo "Frontend HTTP status: $RESPONSE"
          if [ "$RESPONSE" != "200" ]; then
            echo "Frontend health check failed with status $RESPONSE"
            exit 1
          fi

      - name: Log Frontend Health
        run: |
          echo "✓ Frontend health check passed"
          echo "URL: http://${{ secrets.VPS_HOST }}/"
          echo "Status: Healthy"
          echo "Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"

      - name: Log All Health Checks Complete
        run: |
          echo "========================================="
          echo "✓ All Health Checks Passed"
          echo "========================================="
          echo "Backend: HEALTHY (HTTP 200)"
          echo "  URL: ${{ secrets.BACKEND_URL }}/"
          echo ""
          echo "Frontend: HEALTHY (HTTP 200)"
          echo "  URL: http://${{ secrets.VPS_HOST }}/"
          echo ""
          echo "Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "All services operational and ready"
          echo "========================================="
