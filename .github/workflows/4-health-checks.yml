name: Health Checks

on:
  workflow_call:
    secrets:
      BACKEND_URL:
        required: true
      VPS_HOST:
        required: true

jobs:
  health-checks:
    name: Verify Services Health
    runs-on: ubuntu-latest
    steps:
      - name: Wait for backend readiness
        uses: nev7n/wait_for_response@v1
        with:
          url: ${{ secrets.BACKEND_URL }}/
          responseCode: 200
          timeout: 180000
          interval: 10000

      - name: Health Check Backend
        run: |
          echo "Checking backend endpoint..."
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" ${{ secrets.BACKEND_URL }}/)
          echo "Backend HTTP status: $RESPONSE"
          if [ "$RESPONSE" != "200" ]; then
            echo "Backend health check failed with status $RESPONSE"
            exit 1
          fi
          echo "Backend is accessible and responding correctly"

      - name: Wait for frontend readiness
        uses: nev7n/wait_for_response@v1
        with:
          url: http://${{ secrets.VPS_HOST }}/
          responseCode: 200
          timeout: 30000
          interval: 2000

      - name: Health Check Frontend
        run: |
          echo "Checking frontend endpoint..."
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" http://${{ secrets.VPS_HOST }}/)
          echo "Frontend HTTP status: $RESPONSE"
          if [ "$RESPONSE" != "200" ]; then
            echo "Frontend health check failed with status $RESPONSE"
            exit 1
          fi
          echo "Frontend is accessible and responding correctly"

      - name: Log Health Checks Success
        run: |
          echo "SUCCESS: All health checks passed"
          echo "Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "Backend: PASSED (HTTP 200)"
          echo "Frontend: PASSED (HTTP 200)"
          echo "Backend URL: ${{ secrets.BACKEND_URL }}"
          echo "Frontend URL: http://${{ secrets.VPS_HOST }}/"
